name: Tag Appdev Environment

on:
  pull_request:
    types: [ labeled ]

jobs:

  docker_retag:
    runs-on: ubuntu-latest
    steps:

    - name: Check out GitHub Repo
      uses: actions/checkout@v2


    - name: Set App Version and Repo Name
      run: |
        echo ::set-env name=APP_VERSION_NUM::$(sed -n '/module-version:/{n;p;}' kbase.yml | sed 's/ //g')
        echo ::set-env name=MY_APP::$(echo ${GITHUB_REPOSITORY}/$(echo $GITHUB_REPOSITORY | awk -F / '{print $2}' | sed -e "s/:refs//")"-testing")
        echo ::set-env name=MY_SHA::$(git branch --show-current)
        echo ::set-env name=MY_SHA::$(git rev-parse --short=7 HEAD)


## Set target Docker image based on new pull request label

    - name: Set Appdev Target
      if: contains( github.event.pull_request.labels.*.name, 'appdev')
      run: |
        echo ::set-env name=MY_APP::$(echo ${GITHUB_REPOSITORY}/$(echo $GITHUB_REPOSITORY | awk -F / '{print $2}' | sed -e "s/:refs//")"-dev")
        echo "Set Appdev"

    # - name: Set Next Target
    #   if: contains( github.event.pull_request.labels.*.name, 'next')
    #   run: |
    #     echo ::set-env name=MY_APP::$(echo ${GITHUB_REPOSITORY}/$(echo $GITHUB_REPOSITORY | awk -F / '{print $2}' | sed -e "s/:refs//")"-next")
    #     echo "Set Next"

    # - name: Set CI Target
    #   if: contains( github.event.pull_request.labels.*.name, 'ci')
    #   run: |
    #     echo ::set-env name=MY_APP::$(echo ${GITHUB_REPOSITORY}/$(echo $GITHUB_REPOSITORY | awk -F / '{print $2}' | sed -e "s/:refs//")"-ci")
    #     echo "Set CI"

    # - name: Set Production Target
    #   if: contains( github.event.pull_request.labels.*.name, 'prod')
    #   run: |
    #     echo ::set-env name=MY_APP::$(echo ${GITHUB_REPOSITORY}/$(echo $GITHUB_REPOSITORY | awk -F / '{print $2}' | sed -e "s/:refs//")"-prod")
    #     echo "Set Prod"

## Confirm variables

    - name: Verify Version and Repo Name
      run: |
        echo "Version:" $APP_VERSION_NUM
        echo "App:" $MY_APP
        echo "Repo:" $GITHUB_REPOSITORY
        echo git branch -a
        echo git rev-parse --short=7 HEAD

## Tag and push to GPR
        
    - name: Tag Environment
      if: contains( github.event.pull_request.labels.*.name, 'appdev') 
      run: |
        docker login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} docker.pkg.github.com



      # uses: docker/build-push-action@v1
      # with:
      #   username: ${{ github.actor }}
      #   password: ${{ secrets.GITHUB_TOKEN }}
      #   registry: docker.pkg.github.com
      #   repository: ${{ env.MY_APP }}
      #   tags: ${{ env.APP_VERSION_NUM }}
      #   tag_with_sha: true
      #   tag_with_ref: true